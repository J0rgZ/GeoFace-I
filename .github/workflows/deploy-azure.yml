name: Deploy to Azure App Service

on:
  push:
    branches:
      - main  # Cambia a tu rama principal si es diferente
  workflow_dispatch:  # Permite ejecuciÃ³n manual

env:
  AZURE_WEBAPP_NAME: geoface-api  # Cambia por el nombre de tu App Service
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Create deployment package
      env:
        FIREBASE_JSON: ${{ secrets.FIREBASE_JSON }}
      run: |
        # Crear estructura de directorios necesaria
        mkdir -p deployment/app
        mkdir -p deployment/app/uploads
        mkdir -p deployment/app/logs
        
        # Copiar archivos necesarios
        cp -r app/* deployment/app/ 2>/dev/null || echo "âš ï¸ Carpeta app/ no encontrada"
        cp requirements.txt deployment/ 2>/dev/null || echo "âš ï¸ requirements.txt no encontrado"
        cp startup.sh deployment/ 2>/dev/null || echo "âš ï¸ startup.sh no encontrado"
        chmod +x deployment/startup.sh 2>/dev/null || echo "âš ï¸ No se pudo dar permisos a startup.sh"
        cp .deployment deployment/ 2>/dev/null || echo "[config]\nSCM_DO_BUILD_DURING_DEPLOYMENT=true" > deployment/.deployment
        
        # Crear archivo Firebase desde secret (si estÃ¡ configurado)
        # Crear en la raÃ­z del deployment (donde el cÃ³digo lo busca)
        FIREBASE_FILE_ROOT="deployment/geoface-c53eb-firebase-adminsdk-fbsvc-88c24f9a22.json"
        # TambiÃ©n en app/ por si acaso
        FIREBASE_FILE_APP="deployment/app/geoface-c53eb-firebase-adminsdk-fbsvc-88c24f9a22.json"
        
        if [ -n "${FIREBASE_JSON}" ] && [ "${FIREBASE_JSON}" != "" ]; then
          printf '%s\n' "${FIREBASE_JSON}" > "${FIREBASE_FILE_ROOT}"
          printf '%s\n' "${FIREBASE_JSON}" > "${FIREBASE_FILE_APP}"
          echo "âœ… Archivo Firebase creado desde secret (en raÃ­z y app/)"
        else
          # Intentar copiar desde el repo si existe
          if [ -f "app/geoface-c53eb-firebase-adminsdk-fbsvc-88c24f9a22.json" ]; then
            cp app/geoface-c53eb-firebase-adminsdk-fbsvc-88c24f9a22.json "${FIREBASE_FILE_ROOT}"
            cp app/geoface-c53eb-firebase-adminsdk-fbsvc-88c24f9a22.json "${FIREBASE_FILE_APP}"
            echo "âœ… Archivo Firebase copiado desde repo (en raÃ­z y app/)"
          else
            echo "âš ï¸ Archivo Firebase no encontrado (configÃºralo en Azure o como secret FIREBASE_JSON)"
          fi
        fi
        
        # Verificar que el archivo existe
        if [ -f "${FIREBASE_FILE_ROOT}" ]; then
          echo "âœ… Archivo Firebase verificado en raÃ­z: $(ls -lh "${FIREBASE_FILE_ROOT}" | awk '{print $5}')"
        fi
        if [ -f "${FIREBASE_FILE_APP}" ]; then
          echo "âœ… Archivo Firebase verificado en app/: $(ls -lh "${FIREBASE_FILE_APP}" | awk '{print $5}')"
        fi
        
        # Crear archivo .python_version para Azure (opcional pero recomendado)
        echo "3.11" > deployment/.python_version 2>/dev/null || true
        
        cd deployment
        echo "âœ… Paquete de despliegue creado"
        echo ""
        echo "ğŸ“ Estructura del deployment:"
        ls -la
        echo ""
        echo "ğŸ“ Contenido de app/:"
        ls -la app/ || echo "Carpeta app/ no existe"
        echo ""
        echo "ğŸ“ Verificando archivos crÃ­ticos:"
        [ -f "requirements.txt" ] && echo "âœ… requirements.txt" || echo "âŒ requirements.txt NO encontrado"
        [ -f "startup.sh" ] && echo "âœ… startup.sh" || echo "âŒ startup.sh NO encontrado"
        [ -f "app/main.py" ] && echo "âœ… app/main.py" || echo "âŒ app/main.py NO encontrado"
        [ -f "geoface-c53eb-firebase-adminsdk-fbsvc-88c24f9a22.json" ] && echo "âœ… Firebase JSON en raÃ­z" || echo "âš ï¸ Firebase JSON NO en raÃ­z"

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ./deployment
        publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}

